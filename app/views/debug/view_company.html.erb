<% content_for :head do %>
  <script>
    $(document).ready(function () {

      // Convert the markup string into a named template
      $.template( "commentTemplate", "<div style=\"border: 1px dashed #0f0; margin-bottom: .1em;\">${text}<br/>${name}</div>" );

      $(".company-item")
        .mouseover(function() {

          postData = page_element_attrs[$(this).attr("class").split(" ").filter(function(el) {
              return el.indexOf("elid") == 0
            })[0]];

          $.ajax({
            url: '/debug/comment.json',
            success: function(data) {
              $("#comments-sidebox-content").empty();
              $.tmpl("commentTemplate", data).appendTo("#comments-sidebox-content");
            },
            dataType: "json",
            cache: true,
            data: postData
          });

        });
    });
    /*$(document).ready(function () {
      $(".company-item").bind('mouseenter mouseleave', function() {
            $(this).toggleClass('foobar');
          });
    });*/
  </script>
<% end %>

<%
  # global (page-wide) counter for commentable elements
  $on_page_element_id_counter = 0

  # mapping from element's page-id to (class name, database-id)
  $on_page_element_id_attrs = {}

  # probably should be moved to some .rb helper file
  def on_page_element_id(o)
    $on_page_element_id_counter += 1
    class_name = "elid" + $on_page_element_id_counter.to_s
    $on_page_element_id_attrs[class_name] =
      {
        :type => o.class.name,
        :id => o.id
      }
    "company-item " + class_name
  end
%>
  <div class="section-wrapper">
    <section id="company-profile">
        <header>
        <h1><span class="<%= on_page_element_id(@company.company_profile_name) %>">
              <%= @company.name %></span></h1>
          <div id="company-site">
          <% if @company.site %>
            <span class="<%= on_page_element_id(@company.company_profile_site) %>">
              <a href="<%= @company.site %>"><%= @company.site %></a>
            </span>
          <% else %>
            не известен сайт (TODO: линк для жалоб)
          <% end %>
          </div>

          <% if @company.subject %>
            <span id="company-subject <%= on_page_element_id(@company.company_profile_subject) %>"><%= @company.subject %></span>
          <% else %>
            не известна область деятельности компании (TODO: линк для жалоб)
          <% end %>

          <% if @company.originated %>
            , <time id="company-originated" class="<%= on_page_element_id(@company.company_profile_origin_date) %>"><%= @company.originated.year %></time>
          <% else %>
            не известно время основания (TODO: линк для жалоб)
          <% end %>
        </header>

        <% if @company.company_products.any? %>
        <section id="company-products">
            <header><h1>В <%= @company.name %> делают</h1></header>
            <ul class="company-products">
            <% @company.company_products.each do |p| %>
              <li class="company-product">
                <span class="<%= on_page_element_id(p) %>">
                <% if p.site %>
                  <a href="<%= p.site %>"><%= p.name %></a>
                <% else %>
                  <%= p.name %>
                <% end %>
                </span>

                <% if p.description %>
                  <div class="company_product_description"><%= p.description %></div>
                <% end %>
              </li>
            <% end %>
            </ul>
        </section>
        <% end %>

        <% if @company.offices.any? %>
        <section id="company-offices">
            <header><h1>Офис<%= "ы" if @company.offices.length > 1 %></h1></header>

            <% @company.offices.each do |office| %>
            <section class="company-office">
            <header><h1 class="company-office-address <%= on_page_element_id(office) %>"><%= office.address %></h1></header>
                <ul>
                    <% office.bonuses.each do |b| %>
                      <li class="company-office-feature">
                      <% if b.name %><header class="<%= on_page_element_id(b) %>"><%= b.name %></header><% end %>
                      <%= b.description %>
                      </li>
                    <% end %>
                </ul>
            </section>
            <% end %>
          </section>
          <% end %>

        <% if @company.atmosphere %>
        <section id="company-atmosphere">
            <header><h1 class="<%= on_page_element_id(@company.company_profile_atmosphere) %>">Атмосфера</h1></header>
            <p><%= @company.atmosphere %></p>
        </section>
        <% end %>

        <% if @company.technologies %>
        <section id="company-technologies">
          <header><h1 class="<%= on_page_element_id(@company.company_profile_technologies) %>">Технологии</h1></header>
            <p><%= @company.technologies %></p>
        </section>
        <% end %>

        <% if @company.methodologies.any? %>
        <section id="company-methodologies">
          <header><h1>Методологии</h1></header>
            <% @company.methodologies.each do |m| %>
              <p class="<%= on_page_element_id(m) %>">
              <%= "<header>#{m.methodology_base.name}</header>" if m.methodology_base %>
              <%= m.description %>
              </p>
            <% end %>
        </section>
        <% end %>

        <% if @company.source_connections.any? %>
        <section id="company-relations">
            <header><h1>Связи</h1></header>
            <ul>
                <% @company.source_connections.each do |c| %>
                  <li class="company-relation <%= on_page_element_id(c) %>">
                  <%= c.description %> с <%= link_to c.target.name, :controller => :debug, :action => :view_company, :id => c.target %>
                  </li>
                <% end %>
            </ul>
        </section>
        <% end %>
    </section>

    <aside id="comments-sidebox">
      <div id="comments-sidebox-content"></div>
    </aside>
  </div>
  <%= javascript_tag "page_element_attrs = " + $on_page_element_id_attrs.to_json %>
